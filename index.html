<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>360 tool</title>

    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.5.0.js"></script>

    <style type="text/css">
        .fab_frame iframe {
            position: absolute;
            z-index: 1;
            top: 0;
            left: 0;
            width: 70%;
            height: 100%;
        }
        .overlay iframe {
            position: absolute;
            z-index: 2;
            top: 0;
            left: 0;
            width: 70%;
            height: 100%;
        }
        .dashboard {
            position: absolute;
            z-index: 1;
            top: 0;
            right: 0;
            width: 30%;
            height: 100%;
        }
    </style>
</head>

<body>

<!--- overlay to prevent interaction with fab_frame
<div class="overlay">
    <iframe></iframe>
</div>
-->

<div class="fab_frame">
    <iframe src="" id="api-frame" allow="autoplay; fullscreen" allowfullscreen webkitallowfullscreen="true"></iframe>
</div>
<div class="dashboard" id="dashboard">
    <button id="screenshot">Capture</button>
    <button id="rotate">Spin</button>
</div>

<script type="text/javascript">
    var fabview = document.getElementById( 'api-frame' );
    var uid = '4d4dfba6506d40b09b7eb34c642afab7'; // Wade cup
    var client = new Sketchfab( '1.5.0', fabview );

    // screengrab takes a screenshot of the specified resolution
    function screengrab( sketchfab_api, width = 1920, height = 1080 ) {
        sketchfab_api.getScreenShot( width, height, 'image/png', function( err, result ) {
            var anchor = document.createElement( 'a' );
            anchor.href = result;
            anchor.download = 'screenshot.png';
            anchor.innerHTML = '<img width="100" height="100" src=' + result + '>download';
            document.getElementById( 'dashboard' ).appendChild(anchor);

            console.log( 'Screenshot acquired' );
        });
    }

    // turntable returns a camera object for a desired position around the model
    function turntable( initial_camera, frame_index, total = 300.0 ) {
        var increment = ( 2 * Math.PI ) / total;
        var angle = increment * ( frame_index + 1 );
        var distance = Math.sqrt(
            Math.pow( initial_camera.target[0] - initial_camera.position[0], 2 ) +
            Math.pow( initial_camera.target[1] - initial_camera.position[1], 2 ));
        var x = initial_camera.target[0] + distance * Math.cos( angle );
        var y = initial_camera.target[1] + distance * Math.sin( angle );

        return {
            position: [ x, y, initial_camera.position[2]],
            target: initial_camera.target.slice()
        };
    }

    // capture sets the camera to the location specified by turntable, then calls screengrab
    function capture( sketchfab_api, initial_camera, frame_index ) {
        var new_camera = turntable( initial_camera, frame_index );
        sketchfab_api.lookat( new_camera.position, new_camera.target, 0 );

        // need to wait for new camera settings
        // setTimeout( function() {
        //     screengrab( sketchfab_api );
        // }, 10 );
    }

    var onSuccess = function( api ) {
        api.start();

        document.getElementById( 'screenshot' ).addEventListener( 'click', function() {
            screengrab( api );
        });

        document.getElementById( 'rotate' ).addEventListener( 'click', function() {
            api.getCameraLookAt( function( err, camera ) {
                var initial_camera = camera;
                for ( let frame_index = 0; frame_index < 300; frame_index++ ) {
                    setTimeout( function() {
                        console.log( frame_index );
                        capture( api, initial_camera, frame_index );
                    }, frame_index * 50 );
                }
            });
        });

        api.addEventListener( 'viewerready', function() {
            console.log( 'Viewer is ready' );
        } );
    }

    client.init( uid, {
        success: onSuccess,
        error: function onError() {
            console.log( 'Viewer error' );
        },
        autostart: 1,
        annotations_visible: 0,
        camera: 0,
        preload: 1,
        double_click: 0,
        ui_fullscreen: 0,
        ui_stop: 0,
        ui_help: 0,
        ui_settings: 0,
        ui_inspector: 0,
        ui_vr: 0,
        ui_annotations: 0,
        ui_animations: 0,
        ui_infos: 0,
        transparent: 1 // set transparent background
    } );

</script>
</body>
</html>
