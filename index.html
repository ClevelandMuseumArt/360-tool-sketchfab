<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>360 tool</title>

    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.5.0.js"></script>

    <style type="text/css">
        .fab_frame iframe {
            position: absolute;
            z-index: 1;
            top: 0;
            left: 0;
            width: 70%;
            height: 100%;
        }
        .dashboard {
            position: absolute;
            z-index: 2;
            top: 0;
            right: 0;
            width: 25%;
            height: 100%;
        }
    </style>
</head>

<body>
<div class="fab_frame">
    <iframe src="" id="api-frame" allow="autoplay; fullscreen" allowfullscreen webkitallowfullscreen="true"></iframe>
</div>
<div class="dashboard" id="dashboard">
    <button id="screenshot">Preview snapshot</button>
    <button id="spin">Spin</button>

    <div class="field">
        <label class="field-label">Resolution</label>
        <div class="field-control">
            <input type="text" size="4" value="1920" placeholder="width" name="width" title="Width. Max: 1920" required> x
            <input type="text" size="4" value="1080" placeholder="height" name="height" title="Height. Max: 1920" required>
            <small>(1920 max)</small>
        </div>
    </div>
    <div class="field">
        <label class="field-label">Filetype</label>
        <div class="field-control">
            <select id="mimetype-enum">
                <option value="image/png">PNG</option>
                <option value="image/jpeg">JPG</option>
            </select>
        </div>
    </div>
    <button id="record">Capture</button>
    <button id="sandbox">Sandbox</button>
</div>

<script type="text/javascript" src="js/sentinel.js"></script>
<script type="text/javascript" src="js/jszip.min.js"></script>
<script type="text/javascript" src="js/FileSaver.min.js"></script>
<script type="text/javascript">
    var fabview = document.getElementById( 'api-frame' );
    // var uid = '4d4dfba6506d40b09b7eb34c642afab7'; // Wade cup (1944.485)
    var uid = '31a9a4ae69834c42a4869d0610f32515'; // lion headrest (2017.15)
    // var acc_id = '1944.485'; // Wade cup
    var acc_id = '2017.15'; // lion headrest
    var client = new Sketchfab( '1.5.0', fabview );

    var onSuccess = function( api ) {
        api.start();

        document.getElementById( 'screenshot' ).addEventListener( 'click', function() {
            let preview = screengrab( api, 'image/png', 120, 120 );

            preview.then( function( image ) {
                var thumbnail = document.createElement( 'img' );
                thumbnail.src = URL.createObjectURL( image );
                document.getElementById( 'dashboard' ).appendChild( thumbnail );
            });
        });

        document.getElementById( 'spin' ).addEventListener( 'click', function() {
            api.getCameraLookAt( function( err, initial_camera ) {
                var total_frames = 1047;

                turntable( initial_camera, 0, 1 ).then( function( new_camera ) {
                    let offset = Math.atan2( initial_camera.position[ 1 ] - new_camera.target[ 1 ], initial_camera.position[ 0 ] - new_camera.target[ 0 ] );
                    return offset;
                }).then( function( offset ) {
                    for ( let frame_index = 0; frame_index < total_frames; frame_index++ ) {
                        turntable( initial_camera, frame_index, total_frames, offset ).then( function( new_camera ) {
                            setTimeout( function() {
                                return api.lookat( new_camera.position, new_camera.target, 0 );
                            }, frame_index * 70 );
                        });
                    }
                });
            });
        });

        document.getElementById( 'record' ).addEventListener( 'click', function() {
            // get screenshot parameters: resolution, frame count, total frames, mimetype
            api.getCameraLookAt( function( err, initial_camera ) {
                turntable( initial_camera, 0, 1 ).then( function( new_camera ) {
                    let offset = Math.atan2( initial_camera.position[ 1 ] - new_camera.target[ 1 ], initial_camera.position[ 0 ] - new_camera.target[ 0 ] );
                    return offset;
                }).then( function( offset ) {
                    capture( api, 'image/png', initial_camera, 0, 1047, 1920, 1080, offset );
                });
            });
        });

        document.getElementById( 'sandbox' ).addEventListener( 'click', sentinel );

    }

    client.init( uid, {
        success: onSuccess,
        error: function onError() {
            console.log( 'Viewer error' );
        },
        autostart: 1,
        annotations_visible: 0,
        camera: 0,
        preload: 1,
        double_click: 0,
        ui_fullscreen: 0,
        ui_stop: 0,
        ui_help: 0,
        ui_settings: 0, // settings for rendering, navigation & textures
        ui_inspector: 0,
        ui_vr: 0,
        ui_annotations: 0,
        ui_animations: 0,
        ui_infos: 0,
        transparent: 0 // set transparent background
    } );

</script>
</body>
</html>
