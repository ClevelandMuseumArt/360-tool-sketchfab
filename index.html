<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>360 tool</title>

    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.5.0.js"></script>

    <link rel="stylesheet" href="style/fabview.css">
</head>

<body>
    <div class="dashboard" id="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <button id="activate">Start viewer</button>
        <button id="screenshot">Preview snapshot</button>
        <button id="spin">Spin</button>
        <button id="record">Capture</button>
        <button id="sandbox">Sandbox</button>
        <button id="stencil">Toggle stencilbox</button>

        <div class="field">
            <label class="field-label">Filetype</label>
            <div class="field-control">
                <select id="mimetype-enum">
                    <option value="image/png">PNG</option>
                    <option value="image/jpeg">JPG</option>
                </select>
            </div>
        </div>

        <div class="field">
            <label class="field-label">Accession ID</label>
            <div class="field-control">
                <select id="accession-enum">
                    <option value="1915.338.2">1915.388.2 | Deity earring</option>
                    <option value="1916.1521">1916.1521 | Breastplate from hussar's cuirass</option>
                    <option value="1944.485">1944.485 | Wade Cup</option>
                    <option value="1955.166">1955.166 | Mother and Child</option>
                    <option value="1970.16">1970.16 | Neck Amphora</option>
                    <option value="1974.16">1974.16 | Kottabos Element of a Dancing Satyr</option>
                    <option value="1980.16">1980.16 | Piggy Bank</option>
                    <option value="1983.28">1983.28 | Jar</option>
                    <option value="1990.180">1990.180 | Vessel with Ballplayer</option>
                    <option value="2017.15">2017.15 | Headrest with Three Lions</option>
                </select>
            </div>
        </div>
    </div>

    <div id="main">
        <div class="sticky">
            <button id="openbtn" onclick="openNav()">&#9776; Dashboard</button>
        </div>

        <div class="fab_frame">
            <iframe src="" id="api-frame" allow="autoplay; fullscreen" allowfullscreen webkitallowfullscreen="true"></iframe>
        </div>
    </div>

    <div id="tracer">
        <div id="tracerheader">Click here to move</div>
        <img src="assets/test.png" />
    </div>

<script type="text/javascript" src="js/sentinel.js"></script>
<script type="text/javascript" src="js/jszip.min.js"></script>
<script type="text/javascript" src="js/FileSaver.min.js"></script>
<script type="text/javascript">

    dragElement( document.getElementById( 'tracer' ));

    function openNav() {
        document.getElementById( 'sidebar' ).style.width = "250px";
        document.getElementById( 'main' ).style.marginLeft = "250px";
        document.getElementById( 'openbtn' ).style.opacity = "0";
    }

    function closeNav() {
        document.getElementById( 'sidebar' ).style.width = "0";
        document.getElementById( 'main' ).style.marginLeft = "0";
        document.getElementById( 'openbtn' ).style.opacity = "1";
    }

    function dragElement( elt ) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if ( document.getElementById( elt.id + "header" )) {
            document.getElementById( elt.id + "header" ).onmousedown = dragMouseDown;
        } else {
            elt.onmousedown = dragMouseDown;
        }

        function dragMouseDown( e ) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag( e ) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elt.style.top = ( elt.offsetTop - pos2 ) + "px";
            elt.style.left = ( elt.offsetLeft - pos1 ) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    var fabview = document.getElementById( 'api-frame' );
    let acc_id = document.getElementById( 'accession-enum' );
    let uid = ''

    var client = new Sketchfab( '1.5.0', fabview );

    document.getElementById( 'stencil' ).addEventListener( 'click', function() {
        console.log( 'clicked stencil button' );
        var tracer = document.getElementById( 'tracer' );
        console.log( tracer.style.display );
        switch ( tracer.style.visibility ){
            case 'visible':
                tracer.style.visibility = 'hidden';
                break;
            case 'hidden':
                tracer.style.visibility = 'visible';
                break;
        }
    });

    var onSuccess = function( api ) {
        api.start();

        document.getElementById( 'screenshot' ).addEventListener( 'click', function() {
            let preview = screengrab( api, 'image/png', 120, 120 );

            preview.then( function( image ) {
                var thumbnail = document.createElement( 'img' );
                thumbnail.src = URL.createObjectURL( image );
                document.getElementById( 'dashboard' ).appendChild( thumbnail );
            });
        });

        document.getElementById( 'spin' ).addEventListener( 'click', function() {
            api.getCameraLookAt( function( err, initial_camera ) {
                var total_frames = 1047;

                turntable( initial_camera, 0, 1 ).then( function( new_camera ) {
                    let offset = Math.atan2( initial_camera.position[ 1 ] - new_camera.target[ 1 ], initial_camera.position[ 0 ] - new_camera.target[ 0 ] );
                    return offset;
                }).then( function( offset ) {
                    for ( let frame_index = 0; frame_index < total_frames; frame_index++ ) {
                        turntable( initial_camera, frame_index, total_frames, offset ).then( function( new_camera ) {
                            setTimeout( function() {
                                return api.lookat( new_camera.position, new_camera.target, 0 );
                            }, frame_index * 70 );
                        });
                    }
                });
            });
        });

        document.getElementById( 'record' ).addEventListener( 'click', function() {
            // get screenshot parameters: resolution, frame count, total frames, mimetype
            api.getCameraLookAt( function( err, initial_camera ) {
                turntable( initial_camera, 0, 1 ).then( function( new_camera ) {
                    let offset = Math.atan2( initial_camera.position[ 1 ] - new_camera.target[ 1 ], initial_camera.position[ 0 ] - new_camera.target[ 0 ] );
                    return offset;
                }).then( function( offset ) {
                    let mimetype_list = document.getElementById( 'mimetype-enum' );
                    let img_warehouse = new Array( 1047 );
                    capture( api, acc_id.value, mimetype_list.value, initial_camera, 0, 1047, 1920, 1080, offset );
                });
            });
        });

        document.getElementById( 'sandbox' ).addEventListener( 'click', function() {
            api.getCameraLookAt( function( err, initial_camera ) {
                var total_frames = 1047;

                turntable( initial_camera, 0, 1 ).then( function( new_camera ) {
                    let offset = Math.atan2( initial_camera.position[ 1 ] - new_camera.target[ 1 ], initial_camera.position[ 0 ] - new_camera.target[ 0 ] );
                    return offset;
                }).then( function( offset ) {
                    turntable( initial_camera, 875, total_frames, offset ).then( function( new_camera) {
                        return api.lookat( new_camera.position, new_camera.target, 0 );
                    });
                });
            });
        });
    }

    document.getElementById( 'activate' ).addEventListener( 'click', function() {
        switch ( acc_id.value ) {
            case '1915.338.2': // deity earring
                uid = '27834259e0c944af8647b9db1f1f851d';
                break;
            case '1916.1521': // breastplate from hussars cuirass
                uid = '3056e857cf244a3fb651f9d07a66c5a9';
                break;
            case '1944.485': // Wade cup
                uid = '4d4dfba6506d40b09b7eb34c642afab7';
                break;
            case '1955.166': // mother and child
                uid = '5a452eaf4d5d44c1a7a23f7f53d81284';
                break;
            case '1970.16': // neck amphora
                uid = '0bb2525bdd734bf69d5a7b2b051928ad';
                break;
            case '1974.16': // Kottabos
                uid = '34d0cda5076c4c52a8ce2eecd2d192c6';
                break;
            case '1980.16': // piggy bank
                uid = '14bfd106baf14d62aebf6eafbe25b3c3';
                break;
            case '1983.28': // jar
                uid = '1f0a28465735411fb4292e63debf3ffa';
                break;
            case '1990.180': // vessel with Ballplayer
                uid = 'c1ddf562b5bf4d5ba5304ddf2b567cd2';
                break;
            case '2017.15': // headrest with three lions
                uid = '31a9a4ae69834c42a4869d0610f32515';
                break;
            default:
                uid = '';
        }

        client.init( uid, {
            success: onSuccess,
            error: function onError() {
                console.log( 'Viewer error' );
            },
            autostart: 1,
            annotations_visible: 0,
            camera: 0,
            preload: 1,
            double_click: 0,
            ui_fullscreen: 0,
            ui_stop: 0,
            ui_help: 0,
            ui_settings: 0, // settings for rendering, navigation & textures
            ui_inspector: 0,
            ui_vr: 0,
            ui_annotations: 0,
            ui_animations: 0,
            ui_infos: 0,
            transparent: 0 // set transparent background
        });
    });

</script>
</body>
</html>
